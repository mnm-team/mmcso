#!/bin/bash

# The Tiny suite is intended to target a single or few nodes using between 1 and 256 ranks. It uses a maximum of 60GB of memory per benchmark.

# The Small suite is intended to target a single larger node or a small cluster of nodes using between 64 and 1024 ranks. It uses a maximum of 480GB of memory per benchmark.

# The Medium suite is intended to target a mid-sized cluster of nodes using between 256 and 4096 ranks. It uses a maximum of 4TB of memory per benchmark.

# The Larger suite is intended to target a larger cluster of nodes using between 2048 and 32,768 ranks. It uses a maximum of 14.5TB of memory per benchmark.

#PBS -N hpgmgfv 
##PBS -l select=2:node_type=rome:mpiprocs=128
##PBS -l select=2:node_type=rome:ncpus=128:mpiprocs=8
#PBS -l select=2:node_type=rome:ncpus=128
#PBS -l walltime=00:60:00

# Change to the direcotry that the job was submitted from
cd $PBS_O_WORKDIR

export MMCSO_DISPLAY_AFFINITY=TRUE
# export OMP_DISPLAY_AFFINITY=TRUE

set_mmcso_thread_affinity()
{
        echo Placing MMCSO Threads in $1 MPI processes on each $2th Core of each Node with total $3 Cores
        a=$(for i in $(seq 0 $(($1 - 1))); do echo $i:$(( ((($i+1)*$2) - 1) % $3 )); done)
        export MMCSO_THREAD_AFFINITY=$(echo $a | sed -e 's/\s\+/,/g')
}

MMCSO_DIR=/zhome/academic/HLRS/xmu/xmubreit/mmcso/
MMCSO_LIB=$MMCSO_DIR/build/lib/libmmc.so

export LD_LIBRARY_PATH=$MMCSO_DIR/build/lib/:$LD_LIBRARY_PATH


BASEDIR="/zhome/academic/HLRS/xmu/xmubreit/hpc2021/benchspec/HPC/"

VARIANTS="funneled  multiple  offload-funneled  offload-multiple"

#BENCHMARKS="534.hpgmgfv_t 634.hpgmgfv_s 734.hpgmgfv_m 834.hpgmgfv_l"
BENCHMARKS="534.hpgmgfv_t" # 634.hpgmgfv_s" # 734.hpgmgfv_m"

#output_format = text,csv

set_mmcso_thread_affinity 16 16 128

for b in $BENCHMARKS; do
	for v in $VARIANTS; do
		ARGS=$(cat $BASEDIR/$b/$v.args.txt | xargs)
		BENCH="$BASEDIR/$b/exe/hpgmgfv_base.${v}_omp"
		echo $b $v $ARGS
		if [[ $v == *"offload"* ]]; then
			time mpiexec_mpt -ppn 8 -np 16 omplace -nt 15 -c 0-14,16-30,32-46,48-62,64-78,80-94,96-110,112-126 ${BENCH} ${ARGS}
		else
			time mpiexec_mpt -ppn 8 -np 16 omplace -nt 16 -c 0-15,16-31,32-47,48-63,64-79,80-95,96-111,112-127 ${BENCH} ${ARGS}
		fi
		mv spectimes.txt spectimes-$b-$v-conf3.txt
	done
done


